name: CI Retrain
on:
  workflow_dispatch:
  push:
    paths:
      - 'MLProject/**'
      - '.github/workflows/ci.yml'
jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install MLflow
        run: |
          python -m pip install --upgrade pip
          python -m pip install mlflow scikit-learn pandas numpy
      - name: List repo contents
        run: |
          ls -la
          ls -la MLProject
      - name: Run MLflow Project (env-manager=local)
        run: |
          cd MLProject
          export MLFLOW_TRACKING_URI="${GITHUB_WORKSPACE}/MLProject/.mlruns"
          mlflow run . -e train --env-manager=local -P input=namadataset_preprocessing.csv
      - name: Extract MLmodel path and stage CI artifact
        run: |
          set -e
          mkdir -p MLProject/ci_artifacts
          MODEL_PATH=$(find MLProject/.mlruns -name MLmodel -type f | head -n 1 || true)
          if [ -n "$MODEL_PATH" ]; then
            MODEL_DIR=$(dirname "$MODEL_PATH")
            echo "Found MLmodel at: $MODEL_PATH"
            echo "Staging model dir to MLProject/ci_artifacts/model"
            rm -rf MLProject/ci_artifacts/model
            cp -r "$MODEL_DIR" MLProject/ci_artifacts/model
            ls -la MLProject/ci_artifacts/model || true
          else
            echo "No MLmodel found under MLProject/.mlruns; continuing with marker only"
          fi
      - name: List MLflow runs
        run: |
          echo "Root .mlruns:"
          ls -la .mlruns || true
          echo "MLProject .mlruns:"
          ls -la MLProject/.mlruns || true
          echo "Find files in MLProject/.mlruns:"
          find MLProject/.mlruns -type f | head -n 200 || true
          echo "Find files in root .mlruns:"
          find .mlruns -type f | head -n 200 || true
      - name: Ensure artifact directory and marker exists
        run: |
          mkdir -p MLProject/.mlruns
          echo "artifact generated at $(date -u)" > MLProject/.mlruns/ARTIFACT_READY.txt
          ls -la MLProject/.mlruns
      - name: Upload run artifacts from MLProject/.mlruns
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-mlproject
          path: |
            MLProject/.mlruns/**/artifacts/**
            MLProject/.mlruns/**/metrics/**
            MLProject/.mlruns/**/params/**
            MLProject/.mlruns/ARTIFACT_READY.txt
          if-no-files-found: ignore
      - name: Upload staged model directory (fallback)
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-mlproject
          path: |
            MLProject/ci_artifacts/model/**
          if-no-files-found: ignore

  

      