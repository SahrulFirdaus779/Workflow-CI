name: CI Retrain
on:
  workflow_dispatch:
  push:
    paths:
      - 'MLProject/**'
      - '.github/workflows/ci.yml'
jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install MLflow
        run: |
          python -m pip install --upgrade pip
          python -m pip install mlflow scikit-learn pandas numpy
      - name: List repo contents
        run: |
          ls -la
          ls -la MLProject
      - name: Run MLflow Project (env-manager=local)
        run: |
          cd MLProject
          mlflow run . -e train --env-manager=local -P input=namadataset_preprocessing.csv
      - name: List MLflow runs
        run: |
          echo "Root .mlruns:"
          ls -la .mlruns || true
          echo "MLProject .mlruns:"
          ls -la MLProject/.mlruns || true
          echo "Find files in MLProject/.mlruns:"
          find MLProject/.mlruns -type f | head -n 200 || true
          echo "Find files in root .mlruns:"
          find .mlruns -type f | head -n 200 || true
      - name: Upload run artifacts from MLProject/.mlruns
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-mlproject
          path: |
            MLProject/.mlruns/**
          if-no-files-found: warn

      - name: Upload run artifacts from repo-root .mlruns
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-root
          path: |
            .mlruns/**
          if-no-files-found: warn