name: CI Retrain
on:
  workflow_dispatch:
  push:
    paths:
      - 'MLProject/**'
      - '.github/workflows/ci.yml'
jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install MLflow
        run: |
          python -m pip install --upgrade pip
          python -m pip install mlflow scikit-learn pandas numpy
      - name: List repo contents
        run: |
          ls -la
          ls -la MLProject
      - name: Run MLflow Project (env-manager=local)
        run: |
          cd MLProject
          export MLFLOW_TRACKING_URI="${GITHUB_WORKSPACE}/MLProject/.mlruns"
          mlflow run . -e train --env-manager=local -P input=namadataset_preprocessing.csv
      - name: List MLflow runs
        run: |
          echo "Root .mlruns:"
          ls -la .mlruns || true
          echo "MLProject .mlruns:"
          ls -la MLProject/.mlruns || true
          echo "Find files in MLProject/.mlruns:"
          find MLProject/.mlruns -type f | head -n 200 || true
          echo "Find files in root .mlruns:"
          find .mlruns -type f | head -n 200 || true
      - name: Upload run artifacts from MLProject/.mlruns
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-mlproject
          path: |
            MLProject/.mlruns/**/artifacts/**
            MLProject/.mlruns/**/metrics/**
            MLProject/.mlruns/**/params/**
          if-no-files-found: ignore

  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: retrain
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_TOKEN != '' }}
      - uses: actions/setup-python@v5
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_TOKEN != '' }}
        with:
          python-version: '3.12'
      - name: Install MLflow (CLI)
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_TOKEN != '' }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install mlflow
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_TOKEN != '' }}
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}
      - name: Build Docker image from latest model
        working-directory: MLProject
        env:
          IMAGE_NAME: ${{ env.DOCKER_USERNAME }}/workflow-ci-model:latest
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_TOKEN != '' }}
        run: |
          # Find latest run ID
          LATEST_RUN=$(ls -1 .mlruns/0 | tail -n 1)
          echo "Latest run: $LATEST_RUN"
          # Build model image
          mlflow models build-docker \
            -m .mlruns/0/$LATEST_RUN/artifacts/model \
            -n $IMAGE_NAME
      - name: Push Docker image
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_TOKEN != '' }}
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/workflow-ci-model:latest

      # Root .mlruns should be empty since we force tracking URI